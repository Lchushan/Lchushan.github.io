<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react | Liang&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="我的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.64852305.css" as="style"><link rel="preload" href="/assets/js/app.8914b41c.js" as="script"><link rel="preload" href="/assets/js/3.7f8ab6bd.js" as="script"><link rel="preload" href="/assets/js/25.ce0688e9.js" as="script"><link rel="prefetch" href="/assets/js/10.12b4bf37.js"><link rel="prefetch" href="/assets/js/11.986ec194.js"><link rel="prefetch" href="/assets/js/12.127689ae.js"><link rel="prefetch" href="/assets/js/13.528417d2.js"><link rel="prefetch" href="/assets/js/14.ccd1b44f.js"><link rel="prefetch" href="/assets/js/15.df2ae387.js"><link rel="prefetch" href="/assets/js/16.7bbe874c.js"><link rel="prefetch" href="/assets/js/17.4b65eca3.js"><link rel="prefetch" href="/assets/js/18.b4f5604c.js"><link rel="prefetch" href="/assets/js/19.ada119ee.js"><link rel="prefetch" href="/assets/js/2.f7dde802.js"><link rel="prefetch" href="/assets/js/20.d063279a.js"><link rel="prefetch" href="/assets/js/21.d15b3ac7.js"><link rel="prefetch" href="/assets/js/22.5185a1a5.js"><link rel="prefetch" href="/assets/js/23.91b5f7c4.js"><link rel="prefetch" href="/assets/js/24.545bc1fb.js"><link rel="prefetch" href="/assets/js/26.14f7ddb2.js"><link rel="prefetch" href="/assets/js/27.1d380883.js"><link rel="prefetch" href="/assets/js/28.84fd7342.js"><link rel="prefetch" href="/assets/js/29.977a10c6.js"><link rel="prefetch" href="/assets/js/30.e27d5c6c.js"><link rel="prefetch" href="/assets/js/31.fef44b40.js"><link rel="prefetch" href="/assets/js/32.3cde5ab7.js"><link rel="prefetch" href="/assets/js/33.2fd0f2f0.js"><link rel="prefetch" href="/assets/js/34.6174b407.js"><link rel="prefetch" href="/assets/js/35.3457d0d3.js"><link rel="prefetch" href="/assets/js/36.c672256a.js"><link rel="prefetch" href="/assets/js/37.c5336199.js"><link rel="prefetch" href="/assets/js/38.f878aa15.js"><link rel="prefetch" href="/assets/js/39.7272608e.js"><link rel="prefetch" href="/assets/js/4.591798d0.js"><link rel="prefetch" href="/assets/js/40.1f5087ab.js"><link rel="prefetch" href="/assets/js/41.d8defd1f.js"><link rel="prefetch" href="/assets/js/42.4decf61e.js"><link rel="prefetch" href="/assets/js/43.1f54a9fb.js"><link rel="prefetch" href="/assets/js/44.05628c46.js"><link rel="prefetch" href="/assets/js/45.b64569a4.js"><link rel="prefetch" href="/assets/js/46.3e758616.js"><link rel="prefetch" href="/assets/js/47.754e4534.js"><link rel="prefetch" href="/assets/js/48.d7707287.js"><link rel="prefetch" href="/assets/js/49.c62b8419.js"><link rel="prefetch" href="/assets/js/5.ae5a8b30.js"><link rel="prefetch" href="/assets/js/50.60fbaa68.js"><link rel="prefetch" href="/assets/js/51.812c8fc9.js"><link rel="prefetch" href="/assets/js/52.bae4e31b.js"><link rel="prefetch" href="/assets/js/53.bdcc492b.js"><link rel="prefetch" href="/assets/js/54.c9eece36.js"><link rel="prefetch" href="/assets/js/55.bec15e04.js"><link rel="prefetch" href="/assets/js/56.3e4a4b07.js"><link rel="prefetch" href="/assets/js/57.300f3929.js"><link rel="prefetch" href="/assets/js/58.9b3bc2f8.js"><link rel="prefetch" href="/assets/js/59.b4f2f65a.js"><link rel="prefetch" href="/assets/js/6.c6d5d1da.js"><link rel="prefetch" href="/assets/js/60.6da1c705.js"><link rel="prefetch" href="/assets/js/61.0f431e1e.js"><link rel="prefetch" href="/assets/js/62.ca980bdb.js"><link rel="prefetch" href="/assets/js/63.b1d0e0d0.js"><link rel="prefetch" href="/assets/js/64.a5dc88b1.js"><link rel="prefetch" href="/assets/js/65.2134e59f.js"><link rel="prefetch" href="/assets/js/66.2ce26325.js"><link rel="prefetch" href="/assets/js/67.be6c5ba6.js"><link rel="prefetch" href="/assets/js/68.5ee46489.js"><link rel="prefetch" href="/assets/js/69.817ef5b5.js"><link rel="prefetch" href="/assets/js/7.39a2feef.js"><link rel="prefetch" href="/assets/js/70.bd026d5e.js"><link rel="prefetch" href="/assets/js/71.94cd51c9.js"><link rel="prefetch" href="/assets/js/72.2852256c.js"><link rel="prefetch" href="/assets/js/73.ff13867e.js"><link rel="prefetch" href="/assets/js/74.d43a4484.js"><link rel="prefetch" href="/assets/js/75.8a138783.js"><link rel="prefetch" href="/assets/js/76.75869419.js"><link rel="prefetch" href="/assets/js/77.85ccf9b3.js"><link rel="prefetch" href="/assets/js/78.d1f93c97.js"><link rel="prefetch" href="/assets/js/79.476c7345.js"><link rel="prefetch" href="/assets/js/8.6aa44381.js"><link rel="prefetch" href="/assets/js/80.75df788e.js"><link rel="prefetch" href="/assets/js/81.8dabfdfb.js"><link rel="prefetch" href="/assets/js/82.b373d124.js"><link rel="prefetch" href="/assets/js/83.543e5130.js"><link rel="prefetch" href="/assets/js/84.551d04d7.js"><link rel="prefetch" href="/assets/js/85.21a99aad.js"><link rel="prefetch" href="/assets/js/9.ab9a5c08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.64852305.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Liang's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  vuepress
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端知识" class="dropdown-title"><span class="title">前端知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端知识" class="mobile-dropdown-title"><span class="title">前端知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/插件小技巧/" class="nav-link">
  插件小技巧
</a></li><li class="dropdown-item"><!----> <a href="/前端问题/" class="nav-link">
  前端问题
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue问题
</a></li><li class="dropdown-item"><!----> <a href="/react/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  react问题
</a></li><li class="dropdown-item"><!----> <a href="/优化问题/" class="nav-link">
  优化问题
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/regular&amp;git/regular/" class="nav-link">
  正则&amp;git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="画图小软件" class="dropdown-title"><span class="title">画图小软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="画图小软件" class="mobile-dropdown-title"><span class="title">画图小软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/three.js/" class="nav-link">
  three.js
</a></li><li class="dropdown-item"><!----> <a href="/eChart/" class="nav-link">
  eChart
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微前端" class="dropdown-title"><span class="title">微前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="微前端" class="mobile-dropdown-title"><span class="title">微前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/qiankun/" class="nav-link">
  qiankun
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/progress/" class="nav-link">
  记录问题
</a></li><li class="dropdown-item"><!----> <a href="/小案例/" class="nav-link">
  小案例
</a></li></ul></div></div><div class="nav-item"><a href="https://gitee.com/Lchu3/lchushan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  vuepress
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端知识" class="dropdown-title"><span class="title">前端知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端知识" class="mobile-dropdown-title"><span class="title">前端知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/插件小技巧/" class="nav-link">
  插件小技巧
</a></li><li class="dropdown-item"><!----> <a href="/前端问题/" class="nav-link">
  前端问题
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue问题
</a></li><li class="dropdown-item"><!----> <a href="/react/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  react问题
</a></li><li class="dropdown-item"><!----> <a href="/优化问题/" class="nav-link">
  优化问题
</a></li><li class="dropdown-item"><!----> <a href="/node/" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/regular&amp;git/regular/" class="nav-link">
  正则&amp;git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="画图小软件" class="dropdown-title"><span class="title">画图小软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="画图小软件" class="mobile-dropdown-title"><span class="title">画图小软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/three.js/" class="nav-link">
  three.js
</a></li><li class="dropdown-item"><!----> <a href="/eChart/" class="nav-link">
  eChart
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微前端" class="dropdown-title"><span class="title">微前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="微前端" class="mobile-dropdown-title"><span class="title">微前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/qiankun/" class="nav-link">
  qiankun
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/progress/" class="nav-link">
  记录问题
</a></li><li class="dropdown-item"><!----> <a href="/小案例/" class="nav-link">
  小案例
</a></li></ul></div></div><div class="nav-item"><a href="https://gitee.com/Lchu3/lchushan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>react</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react.html" class="sidebar-link">react</a></li><li><a href="/react/" aria-current="page" class="active sidebar-link">react问题总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/#react-的组件间通信都有哪些形式" class="sidebar-link">React 的组件间通信都有哪些形式？</a></li><li class="sidebar-sub-header"><a href="/react/#react-中如何实现路由懒加载" class="sidebar-link">React 中如何实现路由懒加载？</a></li><li class="sidebar-sub-header"><a href="/react/#react-的生命周期函数都有哪些-分别有什么作用" class="sidebar-link">React 的生命周期函数都有哪些，分别有什么作用？</a></li><li class="sidebar-sub-header"><a href="/react/#说一下react-hooks在平时开发中需要注意的问题和原因" class="sidebar-link">说一下React Hooks在平时开发中需要注意的问题和原因?</a></li><li class="sidebar-sub-header"><a href="/react/#react-的-setstate-方法是异步还是同步" class="sidebar-link">React 的 setState 方法是异步还是同步？</a></li><li class="sidebar-sub-header"><a href="/react/#有没有写过-koa-中间件-说下中-间件原理-介绍下自己写过的中间件" class="sidebar-link">有没有写过 Koa 中间件，说下中 间件原理，介绍下自己写过的中间件?</a></li><li class="sidebar-sub-header"><a href="/react/#在-react-项目中-想要进行逻辑复用-有哪些方案" class="sidebar-link">在 React 项目中，想要进行逻辑复用,有哪些方案？</a></li><li class="sidebar-sub-header"><a href="/react/#react中的diff是怎样的" class="sidebar-link">React中的diff是怎样的？</a></li><li class="sidebar-sub-header"><a href="/react/#在-react-中-针对类组件-和-函数组件-分别怎么去进行性能优化" class="sidebar-link">在 React 中，针对类组件 和 函数组件，分别怎么去进行性能优化？</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react"><a href="#react" class="header-anchor">#</a> react</h1> <h2 id="react-的组件间通信都有哪些形式"><a href="#react-的组件间通信都有哪些形式" class="header-anchor">#</a> React 的组件间通信都有哪些形式？</h2> <ol><li>父传子：在 React 中，父组件调用子组件时可以将要传递给子组件的数据添加在子组件的属性中，在子组件中通过 props 属性进行接收。这个就是父组件向子组件通信。</li> <li>子传父：React 是单向数据流，数据永远只能自上向下进行传递。当子组件中有些数据需要向父级进行通信时，需要在父级中定义好回调，将回调传递给子组件，子组件调用父级传递过来的回调方法进行通信。</li> <li>跨组件通信 - context。使用 context API，可以在组件中向其子孙级组件进行信息传递。</li></ol> <h2 id="react-中如何实现路由懒加载"><a href="#react-中如何实现路由懒加载" class="header-anchor">#</a> React 中如何实现路由懒加载？</h2> <p>在 React 16 中，新增了 lazy 方法，通过 lazy 方法可以轻松实现组件懒加载，当然要实现路由懒加载的话，其实也只需要把路由组件结合 lazy 使用即可。  参考代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Route<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>Suspense<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HomeView <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>路由懒加载<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">&quot;/&quot;</span> exact render<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">&lt;</span>Suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>组件Loading进来之前的占位内容<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>HomeView <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>Suspense<span class="token operator">&gt;</span>
            <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre></div><p>在上述代码中，我们使用 lazy 引入了一个动态组件，然后将该组件放入了根路由中。这样的话只有用户访问网站首页时，才会动态加载这个组件。  这里要注意，在 React 规范中，lazy 和 Suspense 必须配合使用，lazy 引入的动态组件必须要放入 Suspense 中，Suspense 的 <code>fallback</code> 属性是 lazy 的组件没有加载进来之前的占位内容。</p> <h2 id="react-的生命周期函数都有哪些-分别有什么作用"><a href="#react-的生命周期函数都有哪些-分别有什么作用" class="header-anchor">#</a> <code>React</code> 的生命周期函数都有哪些，分别有什么作用？</h2> <p>React 的生命周期已经经历了3次改动，我们以最新的版本为准。 具体可以看下图：
挂载阶段：
（1）<code>constructor</code>: 初始化组件，初始化组件的 state 等。
（2）<code>static getDerivedStateFromProps()</code>：该函数用于将 props 中的信息映射到 state 中。
（3）<code>render</code>: 生成虚拟DOM
（4）<code>componentDidMount</code>：组件挂载完成，通过在该函数中去处理副作用 更新阶段：
（5）<code>static getDerivedStateFromProps()</code>
（6）<code>shouldComponentUpdate()</code>：该生命周期函数用于判断是否要进行组件更新。
（7）<code>render()</code>：生成虚拟DOM
（8）<code>getSnapshotBeforeUpdate()</code>：组件已经完成 <code>diff</code>，即将更新真实 DOM，用户获取上一次的DOM快照。该函数必须搭配 <code>componentDidUpdate</code> 一块使用，返回值会变成 <code>componentDidUpdate</code> 第三个参数。
（9）<code>componentDidUpdate()</code>： 组件更新完成，通常在该函数中进行副作用处理。 即将卸载： <code>componentWillUnmount</code>：组件即将卸载，用于删除组件添加到全局的数据或事件。</p> <h2 id="说一下react-hooks在平时开发中需要注意的问题和原因"><a href="#说一下react-hooks在平时开发中需要注意的问题和原因" class="header-anchor">#</a> 说一下React Hooks在平时开发中需要注意的问题和原因?</h2> <p>React Hooks 在使用时注意事项：
（1） 只能在 React 函数中使用（函数式组件或自定义hook）
（2） 只能在函数最外层调用 hook，不能包括在 if，for 等语句中或者子函数中。
（3）<code>useState</code> 中存储的是引用类型的数据时，修改 state 时，一定要返回新的引用。  原因：  面试时关于框架的问题一般问到问题的产生原因，更多考察的就是学员对框架原理的理解。<br>
以这个问题为例，如果不了解原理，我们会得出以下答案：</p> <div class="language- extra-class"><pre><code>1. Hooks 专为函数组件的逻辑复用而设计所以只能用在函数式组件和自定义hooks 
2. hooks 在调用的时候，需要确保先后调用顺序，一个顺序出问题，会导致整个程序的混乱。 
3. 如果在 `useState` 中存储的是引用类型，更新时不更新引用地址时的话，React 会认为我们没有更新数据，则不进行组件更新。  如果在面试时只回答到整个层面，并不会引起面试官的高度注意，也没有办法拉开和普通候选人的区别。这道题在解答的时候，最好结合到原理源码上，在原理实现的层面去深入说明为什么会出现这个问题。当然涉及到原理源码，这道题我们通过文字就不太好表述，所以基于原理源码层次的讲解，我们会放在视频里专门去讲解。
</code></pre></div><p>（讲师视频版解析， 有效期30天，大家记得及时观看学习）：
链接：https://pan.baidu.com/s/1OJ8TEAHoGKeF7mBuTo7gTQ
提取码：0826</p> <h2 id="react-的-setstate-方法是异步还是同步"><a href="#react-的-setstate-方法是异步还是同步" class="header-anchor">#</a> React 的 <code>setState</code> 方法是异步还是同步？</h2> <p><code>setState</code> 在 React 方法中或者 React 事件中是异步的。但是在原生事件，或者异步程序中是同步的。想要更好的解答这个问题 <code>batchedUpdates</code> 的机制。这一点还我们还是通过视频详细的说明。</p> <p>（讲师视频版解析， 有效期30天，大家记得及时观看学习）：
链接：https://pan.baidu.com/s/1pWLDFenzvrsjVY63llWaIQ
提取码：0826</p> <h2 id="有没有写过-koa-中间件-说下中-间件原理-介绍下自己写过的中间件"><a href="#有没有写过-koa-中间件-说下中-间件原理-介绍下自己写过的中间件" class="header-anchor">#</a> 有没有写过 <code>Koa</code> 中间件，说下中 间件原理，介绍下自己写过的中间件?</h2> <h6 id="koa"><a href="#koa" class="header-anchor">#</a> -<code>koa</code></h6> <p><code>koa</code> 本来就是一个轻量级框架，本身支持的功能并不多，功能都是通过中间件来实现不同的需求。开发者可以通过不同的中间件来按需求扩展不同的功能。 <code>koa</code>中中间件本质上就是函数，可以是一个<code>async</code>函数，也可以是一个普通的函数。如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 普通函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">middleWare1</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;I am middleWare1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// async 函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">middleWare2</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;I am middleWare2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleWare1<span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleWare2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h6 id="中间件原理"><a href="#中间件原理" class="header-anchor">#</a> -中间件原理：</h6> <p>中间件会遵循洋葱模型，中间件执行循序并不是会 从头执行到尾，而是会先执行最外层中间件，当调取next()函数后进入下一个中间件执行，一路执行到最里层中间件，然后在从最里层执行到最外层。</p> <h6 id="编写中间件"><a href="#编写中间件" class="header-anchor">#</a> -编写中间件</h6> <p>例如log中间件:通过日志中间件记录网络请求类型及日志，记录请求<code>ip</code>、方式、地址及请求时间。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> requestTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span>  startTime<span class="token punctuation">;</span>
    <span class="token keyword">const</span> logout <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ip<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span>
    fs<span class="token punctuation">.</span><span class="token function">appendFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./log.txt&quot;</span><span class="token punctuation">,</span>logout<span class="token operator">+</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="在-react-项目中-想要进行逻辑复用-有哪些方案"><a href="#在-react-项目中-想要进行逻辑复用-有哪些方案" class="header-anchor">#</a> 在 React 项目中，想要进行逻辑复用,有哪些方案？</h2> <p>到了这个阶段基本确定给候选人的基本功是没有问题的，然后就来看看候选人的一些项目经验怎么样？ 所以可以看到这周的题基本都是与实际开发的积累有一定关联性。 先来看第一道题，在 React 项目中，想要进行逻辑复用，有哪些方案？</p> <p>逻辑复用首先我们应该想到的是组件，但是组件的话除了逻辑的复用之外，还有视图的复用。 很多时候我们只想进行逻辑的复用而不想进行视图的复用，可以怎么处理呢？ 如果只想进行逻辑的复用，而不想进行视图的复用，常用方案如下：</p> <p><code>HOC（高阶组件）</code>、<code>render props</code>、<code>hooks</code></p> <p><code>HOC（高阶组件）</code>类似于高阶函数，在使用高阶组件时，传入一个组件，会返回一个组件。 举个我们使用频率比较多的例子 - <code>withRouter</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Acmp</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>history<span class="token punctuation">,</span>location<span class="token punctuation">,</span>match<span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>视图<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> Bcmp <span class="token operator">=</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>Acmp<span class="token punctuation">)</span>
</code></pre></div><p>在上例中，我们有一个普通组件 <code>Acmp</code> ，本身并不具有路由相关信息。但是，在 <code>Acmp</code> 中，由想要使用路由相关的信息。 这时就可以使用 <code>withRouter</code> 使 <code>Acmp</code> 拥有路由信息。</p> <p><code>withRouter</code> 这个高阶组件的作用就是复用传递给视图组件路由信息这个逻辑。具体使用如下：</p> <p>调用 <code>withRouter</code> 将 <code>Acmp</code> 传递进去，<code>withRouter</code> 会返回一个 <code>Bcmp</code> 。调用 <code>Bcmp</code> 时，会调用<code>Acmp</code>，并将路由信息传递给 <code>Acmp</code>。</p> <p>简易原理如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">withRouter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">Cmp</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Router component<span class="token operator">=</span><span class="token punctuation">{</span>Cmp<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看完了高阶组件之后，我们再来看一下 <code>hooks</code>。</p> <p><code>hooks</code>的出现，主要目的就是解决逻辑复用问题。相比于高阶组件，<code>hooks</code> 的使用更灵活，更自由。 已 <code>Router</code> 的 <code>hooks</code> 对比 <code>withRouter</code> 。使用 <code>withRouter</code> 时，会一次性将路由所有相关数据导入组件， 而 <code>hooks</code> 我们按照需求只导入 <code>location</code>或 <code>history</code>等。 另外一个组件中，要复用多个逻辑时，高阶组件明显使用起来就比较不便。 比如在 <code>Acmp</code> 组件中，我们既需要使用 <code>Redux</code> 相关数据，又需要路由信息时，结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Acmp</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>history<span class="token punctuation">,</span>location<span class="token punctuation">,</span>match<span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>视图<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> Bcmp <span class="token operator">=</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>Acmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Ccmp <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">)</span><span class="token punctuation">(</span>Bcmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以看到每复用一个逻辑就需要包一层，极其不方便。</p> <p>总结一下，高阶组件可以做的事情，<code>hooks</code> 都可以去做，而且 <code>hooks</code>的使用比高级组件更灵活也更方便，但是<code>hooks</code> 只能用在函数组件下。</p> <p>看完了 <code>hooks</code> 和 <code>HOC</code>之后，我们再来看看 <code>render props</code>。</p> <p><code>render props</code> 同样是<code>react</code> 中，复用逻辑的小技巧，并不是标准定义的 <code>API</code>。 简单来说，就是组件具有一个<code>render</code> 属性，该属性接收的是一个函数，该组件中要渲染的视图是<code>render</code>属性的返回值。 举一个我们使用最多的常见，<code>Route</code> 组件的<code>render</code>属性。</p> <div class="language-html extra-class"><pre class="language-html"><code>&lt;Router path='/home' render={()=&gt;{
    return <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HomeView</span> <span class="token punctuation">/&gt;</span></span>
    }}&gt;
</code></pre></div><p><code>Route</code> 组件中的这个<code>render</code> 属性就是一个关于 <code>render props</code>的实际应用。 将组件内要渲染的视图放在 <code>render</code>属性的返回值中，而组件本身是一个路由逻辑的共用。 这样就做到了功能复用而视图自定义。</p> <p>Route 简易原理如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Route</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>path<span class="token punctuation">,</span>render<span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">matchPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
            <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">render</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这里我们看到了<code>render props</code> 、<code>HOC</code>和 <code>hooks</code>，那在使用场景上，三者有什么差异呢?</p> <p><code>HOC</code> 和 <code>hooks</code>刚刚我们说过，这里主要来看 <code>render props</code> 和其他两项的差异。</p> <p>大家可能在网上找过，网上也给出了很多答案，比如设计模式上，比如对视图的控制上，但是这些都没有说到根上。已经到了二面，面试官更关心的是使用经验，而非理论知识。下面是我个人的一些开发经验总结：</p> <p>高阶组件或<code>hook</code>，通常用在单一的逻辑复用，比如实时获取当前滚动条位置，或定义<code>state</code>，副作用处理等，都是单一的逻辑。 而 <code>render props</code> 通常是一个完整的功能复用，只是该功能中视图或部分视图需要由使用者定义，比如，弹窗功能，路由功能 等，项目中使用到这些功能的地方有很多，但是使用时，视图可能有差异。</p> <p>关于 React 的逻辑复用问题，就解析到这里。</p> <h2 id="react中的diff是怎样的"><a href="#react中的diff是怎样的" class="header-anchor">#</a> React中的<code>diff</code>是怎样的？</h2> <p>来看一下，<code>React diff</code>这道题。</p> <p><code>React diff</code>用于等比新旧 DOM树 的差异，简单来说也可以说是对比两个 <code>Object tree</code>之间的差异。如下例：</p> <p>更新前：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>	
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span>    
    <span class="token property">&quot;props&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>        
        <span class="token property">&quot;className&quot;</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span>        
        <span class="token comment">//...    </span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>   
    <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>     
            <span class="token comment">// ... </span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>    
            <span class="token comment">//... </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更新后：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>	
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span>  
    <span class="token property">&quot;props&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>      
        <span class="token property">&quot;className&quot;</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span>  
        <span class="token comment">// ...  </span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>   
    <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>     
            <span class="token comment">//  ... </span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>    
            <span class="token comment">//  ... </span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>    
            <span class="token comment">//  ... </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里为了方便展示对结构虚拟DOM的结构稍稍调整了一下，但是意思和 <code>React</code>原本的结构其实是一致的对结构了解之后，我们就来分析一下，一个虚拟DOM，会做处理哪些更新，对哪些更新清晰之后，我们就比较好直观认识 <code>diff</code>的过程。</p> <p>对视图的操作，我们统计下来一共有 6 种，分别是:</p> <ol><li>替换节点</li> <li>替换属性</li> <li>添加新节点</li> <li>移动节点或者说插入节点</li> <li>删除节点</li> <li>修改文本节点内容</li></ol> <p>明确了我们要对比出哪些差异之后，我们来看看 <code>diff</code>的实现过程。在 <code>React Diff</code>中，考虑到平时在进行节点操作时，跨层移动节点的需求会比较小，所以采取了同层比较的策略。</p> <p>什么是跨层，可以看下图：</p> <p><img src="/assets/img/image-20210527133100000.c14eb9c4.png" alt="image-20210527133100000.png"></p> <p>在不考虑跨层对比的情况下，<code>diff</code>的性能会有一个很大提升，另外我们的实现逻辑也会简化很多。 只考虑同层对比，我们在实现 <code>diff</code>的时候，只需要一层层向下递归我们的 <code>diff</code>即可。 接下来具体来看看 <code>diff</code> 的实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">oldTree<span class="token punctuation">,</span>newTree</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	
    <span class="token function">diffNode</span><span class="token punctuation">(</span>oldTree<span class="token punctuation">,</span>newTree<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第一步实现 <code>diff</code> 方法，来开始 <code>diff</code>，调用时需要传入<code>oldTree</code> （更新前的 虚拟DOM树），<code>newTree</code> 更新后的DOM 树 在 <code>diff</code>中，先进行顶层节点的对比，接下来就是一层一层的递归向下。</p> <p>现在看看 <code>diffNode</code> 的实现过程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffNode</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span>newNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	
    <span class="token keyword">if</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">.</span>type <span class="token operator">!=</span> newNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token comment">// 第一步判断更新前后的节点类型是否不一致		</span>
        <span class="token comment">// 如果节点类型不一致了，那就不用再往下对比，直接替换节点即可	</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>判断当前节点是否是文本节点<span class="token punctuation">)</span><span class="token punctuation">{</span>		
        <span class="token keyword">if</span><span class="token punctuation">(</span>对比新旧文本节点的内容是否发生了变化<span class="token punctuation">)</span><span class="token punctuation">{</span>		
            <span class="token comment">// 如果文本节点的内容发生了变化，则直接替换文本内容	</span>
        <span class="token punctuation">}</span>	
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> oldVNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 判断当前是否是一个组件	</span>
        <span class="token function">diffCmp</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">,</span>newNode<span class="token punctuation">)</span> 
        <span class="token comment">//进行组件对比	</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>		
        <span class="token comment">// 当前如果是一个普通的元素节点	</span>
        <span class="token comment">// 对比属性有没有变化		</span>
        <span class="token function">diffProps</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>props<span class="token punctuation">,</span>newNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span>	
        <span class="token comment">// 对比子元素		</span>
        <span class="token function">diffChildren</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span>newNode<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述是对单个节点的对比过程，在对比单个节点时，最后通过 <code>diffCmp</code>组件对比，或者 <code>diffChildren</code> 子元素对比，接着向下递归。</p> <p>接下来先来看看 <code>diffCmp</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dissCmp</span><span class="token punctuation">(</span><span class="token parameter">oldCmp<span class="token punctuation">,</span>newCmp</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    
    <span class="token comment">/*    在这里我们忽略掉生命周期的部分，    
    主要就是调用组件组件自身的更新，    
    组件更新时。render之后，会再次调用diff方法，    
    去对比这个组件下的虚拟DOM的不同    */</span>
    oldCmp<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>newVCmp<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看完了 <code>diffCmp</code> 之后，我们先来看 <code>diffProps</code> 属性对比，了解属性对比的过程之后，再学习 <code>diffChildren</code> 会更直观一些。</p> <p>虚拟<code>DOM</code> 中的属性，其实就是一个普通的 <code>object</code> 对象，在其中会有三种不同的操作，需要我们在对比时进行考虑：</p> <ol><li>新增属性</li> <li>删除属性</li> <li>属性值有变动</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span>nextProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> s <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>     
        <span class="token keyword">if</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token comment">//该属性在更新前后都存在       </span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">!==</span> nextProps<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
                <span class="token comment">//检测概述值是否有变化             </span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'属性值发生变化'</span><span class="token punctuation">)</span>    
            <span class="token punctuation">}</span>     
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token comment">// 该属性只存在于更新之后    </span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'新建的属性'</span><span class="token punctuation">)</span>   
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> s <span class="token keyword">in</span> prevProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
        <span class="token keyword">if</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">// 该属性只存在新增之前   </span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'被删除了'</span><span class="token punctuation">)</span>   
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从上述代码中，我们可以通过两个循环，我们就可以将属性中有差异的内容给找出来。</p> <p>第一步，先循环更新后的 <code>props</code> ，如果在更新的 <code>props</code> 中也有对应属性，则比较属性值是否有变化。如果在更新前的 <code>props</code> 中，不存在对应属性，则该项为新增属性。</p> <p>第二步。循环更新前的<code>props</code>，如果在更新后的 <code>props</code> 不存在对应属性，则该项属性需要被删除。看完了属性对比之后，我们来看一下最复杂的子元素对比。这里我将 children 做了简化，React 中 children 有可能存在 单个数据、数组、复合数组多种情况。我们这里主要看最麻烦的数组的形式。还是来分析在一组子元素对比时，我们要做哪些对比。</p> <ul><li><p>新增元素</p></li> <li><p>删除元素</p></li> <li><p>元素位置变化</p></li> <li><p>递归对比单个元素</p></li></ul> <p>明确了要做哪些对比之后，我们再来思考一个问题，如何将更新前后的元素进行对应，<code>prevChildren[0]</code>否就是<code>nextChildren[0]</code>呢？</p> <p>这种情况下，我们可以参考上边 <code>diffProps</code> ，如果这些子元素是存在对象中的，并且更新前后，对象的属性名保持统一，那我们对比起来将极其方便。</p> <p>这种情况下，我们的 key 属性的作用就明确了。观看下列代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setKeys</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>   
        <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> index <span class="token operator">:</span> item<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      
        key <span class="token operator">=</span> <span class="token string">&quot;key-&quot;</span> <span class="token operator">+</span> key     
        keys<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> item  
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> keys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个函数中，我们利用 key 属性，将 children 转成 对象，这样的话，就可以将 <code>diffProps</code> 的逻辑嵌套入<code>diffChildren</code> 中来。具体代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">diffChildren</span> <span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span>nextChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token keyword">const</span> prevKeys <span class="token operator">=</span> <span class="token function">setKeys</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">const</span> nextKeys <span class="token operator">=</span> <span class="token function">setKeys</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> nextKeys<span class="token punctuation">)</span><span class="token punctuation">{</span>      
        <span class="token keyword">if</span><span class="token punctuation">(</span>prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token comment">// 更新前的列表中存在该节点    </span>
            <span class="token function">diffNode</span><span class="token punctuation">(</span>prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">// 进一步进行节点对比    </span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token comment">// 更新前的列表中不存在该节点  </span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'新增节点'</span><span class="token punctuation">)</span>   
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> s <span class="token keyword">in</span> prevKeys<span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">// 新列表中不存在该节点      </span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'要删除项'</span><span class="token punctuation">)</span>   
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在我们还差最后一步，如何找到哪些元素的位置，发生了变化。来看一个思路： 默认情况下，后一个的索引值，不小于前一个元素，如果元素的下标符合这个原则，那则代表元素的位置，没有发生变化。</p> <p>举个例子。 更新前的列表：a(0) b(1) c(2) d(3) 更新后的列表: b a d c</p> <p>这里有一个列表更新前后位置产生了变化，如果将发生移动的元素找出来，我们套用上边的思路，来看一下。</p> <p>第一步声明一个变量<code>lastIndex = 0</code>;</p> <p>使用 <code>lastIndex</code> 先和 b 元素进行对比，b 元素的下标为 1，<code>lastIndex</code>为 0. 1 不小于 0 ，符合规则，b 位置不变。</p> <p><code>lastIndex</code> 变成 1，接着和下一个元素进行对比。</p> <p>使用 <code>lastIndex</code> 和 a 比较，a 下标为 0，<code>lastIndex</code> 为 1，不符合规则，记录 a 的位置发生了变化。接着对比下一个元素</p> <p>使用 <code>lastIndex</code> 和 d 比较，d 下标为 3，<code>lastIndex</code> 为 1，符合规则。 <code>lastIndex</code> 变成 3，继续比较下一个元素。</p> <p>使用<code>lastIndex</code> 和 c 比较，a 下标为 2，<code>lastIndex</code> 为 3，不符合规则，记录 c 的位置发生了变化。</p> <p>这样我们就可以将位置发生变化的 a 和 c 找了出来，基于这个原则，我们重新修改一下我们的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setKeys</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">let</span> keys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  
        <span class="token keyword">let</span> key <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> index <span class="token operator">:</span> item<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   
        key <span class="token operator">=</span> <span class="token string">&quot;key-&quot;</span> <span class="token operator">+</span> key      
        keys<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> item      
        keys<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>_index <span class="token operator">=</span> index<span class="token punctuation">;</span> 
        <span class="token comment">//这里新增属性，_index用于记录元素在数组中的下标（位置）</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>   
    <span class="token keyword">return</span> keys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">diffChildren</span> <span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span>nextChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> prevKeys <span class="token operator">=</span> <span class="token function">setKeys</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">const</span> nextKeys <span class="token operator">=</span> <span class="token function">setKeys</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token comment">//声明变量lastIndex用于记录上一个元素的下标    </span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> nextKeys<span class="token punctuation">)</span><span class="token punctuation">{</span>     
        <span class="token keyword">if</span><span class="token punctuation">(</span>prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
            <span class="token function">diffNode</span><span class="token punctuation">(</span>prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token keyword">if</span><span class="token punctuation">(</span>lastIndex <span class="token operator">&gt;</span> prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>_index<span class="token punctuation">)</span><span class="token punctuation">{</span>      
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'位置变化'</span><span class="token punctuation">)</span>   
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>         
                <span class="token comment">// 如果该元素位置没有发生变化，则更新lastIndex，以方便下一次进行对比     </span>
                lastIndex <span class="token operator">=</span> prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>_index<span class="token punctuation">;</span>     
            <span class="token punctuation">}</span>     
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>     
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'新增节点'</span><span class="token punctuation">)</span>       
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>   
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> s <span class="token keyword">in</span> prevKeys<span class="token punctuation">)</span><span class="token punctuation">{</span>  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>nextKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prevKeys<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'要删除项'</span><span class="token punctuation">)</span>   
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这一步，我们就完成了 <code>diff</code> 的整个流程的梳理。当然文字描述的话，有些问题描述的不是很直观，大家可以观看一下这道题的视频讲解的会更直观一些。</p> <h2 id="在-react-中-针对类组件-和-函数组件-分别怎么去进行性能优化"><a href="#在-react-中-针对类组件-和-函数组件-分别怎么去进行性能优化" class="header-anchor">#</a> 在 React 中，针对类组件 和 函数组件，分别怎么去进行性能优化？</h2> <p>接下来看优化的这道题, 在 React 中，针对类组件 和 函数组件，分别怎么去进行性能优化? 组件优化除了最基础的 key 之外，主要考察点，在于优化组件更新。</p> <p>React 中，如果组件更新了，会携带它的子孙级组件一起进行更新，虽然组件更新时，会有<code>diff</code>约束DOM更新。 但组件更新时的 <code>dif</code>f，也会消耗很多性能。 如何避免项目中不必要的组件更新就是我们必须要面对的问题。 如果是类组件我们可以使用 <code>shouldComponentUpdate</code> 或者<code>PureComponent</code> , 函数组件则可以使用 memo 具体的 <code>API</code> 使用我就不再复述了，大家可以看下视频， 或者看看</p> <p>官网手册<code>React.memo</code> https://reactjs.org/docs/react-api.html#reactmemo</p> <p><code>React.PureComponent</code> https://reactjs.org/docs/react-api.html#reactpurecomponent</p> <p>这里一定要注意，不管你使用的是哪种优化手段，state 一定是一个不可变值，否则拿不到组件更新前的数据， 也就没有办法进行对比，优化也就无从谈起。关于组件优化的问题，就到这里。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/react.html" class="prev">
        react
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8914b41c.js" defer></script><script src="/assets/js/3.7f8ab6bd.js" defer></script><script src="/assets/js/25.ce0688e9.js" defer></script>
  </body>
</html>
